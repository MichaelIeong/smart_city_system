<script type="text/html" data-template-name="Sensor">
    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <select id="node-input-location">
            <option value="" disabled selected>Select Location</option>
        </select>
    </div>

    <div class="form-row">
        <button type="button" id="node-input-switch-to-type" class="btn btn-secondary">Switch to Device Type</button>
    </div>

    <div class="form-row" id="device-name-row">
        <label for="node-input-device-name"><i class="fa fa-mobile"></i> Device Name</label>
        <select id="node-input-device-name">
            <option value="" disabled selected>Select Device Name</option>
        </select>
    </div>

    <div class="form-row" id="deviceType-row" style="display: none;">
        <label for="node-input-deviceType"><i class="fa fa-window-restore"></i> Device Type</label>
        <select id="node-input-deviceType">
            <option value="" disabled selected>Select Device Type</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-sensingFunction"><i class="fa fa-search"></i> Sensing Function</label>
        <select id="node-input-sensingFunction">
            <option value="" disabled selected>Select an ability of this sensor</option>
        </select>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('Sensor', {
        category: 'Event Fusion',
        color: "#f89f9f",
        defaults: {
            name: { value: "" },
            location: { value: "" },
            deviceName: { value: "" },
            deviceType: { value: "" },
            sensingFunction: { value: "" }
        },
        inputs: 0,
        outputs: 1,
        icon: "bridge.svg",
        label: function () {
            if (this.deviceName) {
                return "Sensor : " + this.deviceName;
            } else if (this.deviceType) {
                return "Sensor : " + this.deviceType;
            } else {
                return "Sensor : ";
            }
        },
        oneditprepare: function () {
            var node = this;
            var projectId = 1;
            var sensorsData = [];

            var locationSelect = $("#node-input-location");
            var deviceNameSelect = $("#node-input-device-name");
            var deviceTypeSelect = $("#node-input-deviceType");
            var sensingFunctionSelect = $("#node-input-sensingFunction");

            function populateSelectOptions(selectElement, options, defaultText) {
                selectElement.empty().append('<option value="" disabled selected>' + defaultText + '</option>');
                options.forEach(function (option) {
                    selectElement.append($("<option></option>").attr("value", option.value).text(option.text));
                });
            }

            function updateSensingFunctions(selectedDevice, type) {
                sensingFunctionSelect.empty().append('<option value="" disabled selected>Select an ability of this sensor</option>');
                var filteredSensor = sensorsData.find(function (sensor) {
                    return (type === 'deviceName' && sensor.deviceName === selectedDevice) ||
                        (type === 'deviceType' && sensor.deviceType === selectedDevice);
                });
                if (filteredSensor && Array.isArray(filteredSensor.function)) {
                    filteredSensor.function.forEach(function (func) {
                        sensingFunctionSelect.append($("<option></option>").attr("value", func).text(func));
                    });
                }
                // 在函数填充完成后，如果有已保存的sensingFunction则恢复
                if (node.sensingFunction) {
                    sensingFunctionSelect.val(node.sensingFunction);
                }
            }

            $.getJSON("http://127.0.0.1:8080/api/fusion/sensor/" + projectId, function (data) {
                if (!data || data.length === 0) {
                    console.error("No data received from the API.");
                    return;
                }
                sensorsData = data;

                // 填充location
                var locations = Array.from(new Set(data.map(function (sensor) { return sensor.location; })));
                populateSelectOptions(locationSelect, locations.map(loc => ({ value: loc, text: loc })), "Select Location");

                // 设置保存的值(如果有)
                locationSelect.val(node.location);

                // 绑定事件
                locationSelect.off('change').on('change', function () {
                    var selectedLocation = locationSelect.val();
                    var filteredSensors = sensorsData.filter(function (sensor) {
                        return sensor.location === selectedLocation;
                    });

                    var deviceNames = filteredSensors.map(sensor => ({ value: sensor.deviceName, text: sensor.deviceName }));
                    var deviceTypes = filteredSensors.map(sensor => ({ value: sensor.deviceType, text: sensor.deviceType }));

                    populateSelectOptions(deviceNameSelect, deviceNames, "Select Device Name");
                    populateSelectOptions(deviceTypeSelect, deviceTypes, "Select Device Type");

                    // 当location变化后清空sensingFunction的显示
                    sensingFunctionSelect.empty().append('<option value="" disabled selected>Select an ability of this sensor</option>');

                    // 如果node中有已保存的deviceName，则重新设置
                    if (node.deviceName) {
                        deviceNameSelect.val(node.deviceName);
                        // 触发updateSensingFunctions来填充sensing function
                        updateSensingFunctions(node.deviceName, 'deviceName');
                    }

                    // 如果node中有已保存的deviceType，则重新设置
                    if (node.deviceType) {
                        deviceTypeSelect.val(node.deviceType);
                        updateSensingFunctions(node.deviceType, 'deviceType');
                    }
                });

                deviceNameSelect.off('change').on('change', function () {
                    var selectedDeviceName = deviceNameSelect.val();
                    updateSensingFunctions(selectedDeviceName, 'deviceName');
                });

                deviceTypeSelect.off('change').on('change', function () {
                    var selectedDeviceType = deviceTypeSelect.val();
                    updateSensingFunctions(selectedDeviceType, 'deviceType');
                });

                // 如果location已保存则触发一次change来填充其他选项
                if (node.location) {
                    locationSelect.trigger('change');
                } else {
                    // 如果没有location，那就不强制触发，这样用户在编辑时选择即可
                    // 同样如果没有deviceName/deviceType，就不自动选。
                }
            });

            function initView() {
                if (node.deviceName && node.deviceName !== "") {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                } else if (node.deviceType && node.deviceType !== "") {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    // 默认显示device-name选择
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            }

            initView();

            $("#node-input-switch-to-type").off('click').on('click', function () {
                var isDeviceNameVisible = $("#device-name-row").is(":visible");
                if (isDeviceNameVisible) {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            });
        },
        oneditsave: function () {
            this.name = $("#node-input-name").val();
            this.location = $("#node-input-location").val();
            this.deviceName = $("#node-input-device-name").val();
            this.deviceType = $("#node-input-deviceType").val();
            this.sensingFunction = $("#node-input-sensingFunction").val();

            console.log("Saved node state:", {
                name: this.name,
                location: this.location,
                deviceName: this.deviceName,
                deviceType: this.deviceType,
                sensingFunction: this.sensingFunction
            });
        }
    });
</script>

<style>
    .form-row input[type="text"],
    .form-row select {
        width: calc(100% - 180px);
        box-sizing: border-box;
    }

    .form-row button {
        margin-left: 150px;
        padding: 10px 20px;
        background-color: rgba(255, 255, 255, 0.71);
        border: 1px solid #b8b8b8;
        border-radius: 5px;
        color: #000000;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
</style>x