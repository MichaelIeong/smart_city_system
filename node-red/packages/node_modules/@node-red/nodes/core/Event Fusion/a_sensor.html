<script type="text/html" data-template-name="Sensor">

    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <select id="node-input-location">
            <option value="" disabled selected>Select Location</option>
        </select>
    </div>

    <div class="form-row">
        <button type="button" id="node-input-switch-to-type" class="btn btn-secondary">Switch to Device Type</button>
    </div>

    <div class="form-row" id="device-name-row">
        <label for="node-input-device-name"><i class="fa fa-mobile"></i> Device Name</label>
        <select id="node-input-device-name">
            <option value="" disabled selected>Select Device Name</option>
        </select>
    </div>

    <div class="form-row" id="deviceType-row" style="display: none;">
        <label for="node-input-deviceType"><i class="fa fa-window-restore"></i> Device Type</label>
        <select id="node-input-deviceType">
            <option value="" disabled selected>Select Device Type</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-sensingFunction"><i class="fa fa-search"></i> Sensing Function</label>
        <select id="node-input-sensingFunction">
            <option value="" disabled selected>Select an ability of this sensor</option>
        </select>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('Sensor', {
        category: 'Event Fusion',
        color: "#f89f9f",
        defaults: {
            name: { value: "" },
            location: { value: "" },
            deviceName: { value: "" },
            deviceType: { value: "" },
            sensingFunction: { value: "" }
        },
        inputs: 0,
        outputs: 1,
        icon: "bridge.svg",
        label: function () {
            if (this.deviceName) {
                return "Sensor : " + this.deviceName;
            } else if (this.deviceType) {
                return "Sensor : " + this.deviceType;
            } else {
                return "Sensor : ";
            }
        },
        oneditprepare: function () {
            var node = this;
            var projectId = 1; // Replace this with actual project name variable

            $.getJSON("http://127.0.0.1:8080/api/fusion/sensor/" + projectId, function (data) {
                var locationSelect = $("#node-input-location");
                var deviceNameSelect = $("#node-input-device-name");
                var deviceTypeSelect = $("#node-input-deviceType");
                var sensingFunctionSelect = $("#node-input-sensingFunction");

                // Clear previous options
                locationSelect.empty().append('<option value="" disabled selected>Select Location</option>');
                deviceNameSelect.empty().append('<option value="" disabled selected>Select Device Name</option>');
                deviceTypeSelect.empty().append('<option value="" disabled selected>Select Device Type</option>');
                sensingFunctionSelect.empty().append('<option value="" disabled selected>Select an ability of this sensor</option>');

                // Collect unique locations
                var locations = new Set();
                data.forEach(function (sensor) {
                    locations.add(sensor.location);
                });

                // Populate location dropdown with unique values
                locations.forEach(function (location) {
                    locationSelect.append($("<option></option>").attr("value", location).text(location));
                });

                // Update deviceName/deviceType based on selected location
                locationSelect.change(function () {
                    var selectedLocation = locationSelect.val();

                    // Clear deviceName and deviceType options
                    deviceNameSelect.empty().append('<option value="" disabled selected>Select Device Name</option>');
                    deviceTypeSelect.empty().append('<option value="" disabled selected>Select Device Type</option>');

                    // Filter sensors by selected location
                    var filteredSensors = data.filter(function (sensor) {
                        return sensor.location === selectedLocation;
                    });

                    // Populate deviceName/deviceType dropdowns
                    filteredSensors.forEach(function (sensor) {
                        deviceNameSelect.append($("<option></option>").attr("value", sensor.deviceName).text(sensor.deviceName));
                        deviceTypeSelect.append($("<option></option>").attr("value", sensor.deviceType).text(sensor.deviceType));
                    });
                });

                // Update sensingFunction based on selected deviceName or deviceType
                deviceNameSelect.change(function () {
                    var selectedDeviceName = deviceNameSelect.val();
                    updateSensingFunctions(selectedDeviceName, 'deviceName');
                });

                deviceTypeSelect.change(function () {
                    var selectedDeviceType = deviceTypeSelect.val();
                    updateSensingFunctions(selectedDeviceType, 'deviceType');
                });

                function updateSensingFunctions(selectedDevice, type) {
                    sensingFunctionSelect.empty().append('<option value="" disabled selected>Select an ability of this sensor</option>');

                    var filteredSensor = data.find(function (sensor) {
                        return (type === 'deviceName' && sensor.deviceName === selectedDevice) ||
                            (type === 'deviceType' && sensor.deviceType === selectedDevice);
                    });

                    if (filteredSensor) {
                        //console.log(filteredSensor);
                        filteredSensor.function.forEach(function (func) {
                            console.log(func);
                            sensingFunctionSelect.append($("<option></option>").attr("value", func).text(func));
                        });
                    }
                }

                // Set initial view
                locationSelect.val(node.location);
                deviceNameSelect.val(node.deviceName);
                deviceTypeSelect.val(node.deviceType);
                sensingFunctionSelect.val(node.sensingFunction);
            });

            function initView() {
                if (node.deviceName && node.deviceName !== "") {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                } else {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                }
            }

            initView();

            $("#node-input-switch-to-type").click(function () {
                var isDeviceNameVisible = $("#device-name-row").is(":visible");
                if (isDeviceNameVisible) {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            });
        },
        oneditsave: function () {
            this.name = $("#node-input-name").val();
            this.location = $("#node-input-location").val();
            this.deviceName = $("#node-input-device-name").val();
            this.deviceType = $("#node-input-deviceType").val();
            this.sensingFunction = $("#node-input-sensingFunction").val();
        }
    });
</script>
<style>
    /* 设置所有输入框和下拉框宽度一致 */
    .form-row input[type="text"],

    .form-row select {
        width: calc(100% - 180px); /* 留出空间给标签 */
        box-sizing: border-box; /* 确保padding和border包含在宽度内 */
    }

    /* 按钮样式调整 */
    .form-row button {
        margin-left: 150px; /* 与label宽度一致 */
        padding: 10px 20px;
        background-color: rgba(255, 255, 255, 0.71); /* 按钮背景颜色 */
        border: 1px solid #b8b8b8; /* 按钮边框 */
        border-radius: 5px; /* 圆角按钮 */
        color: #000000; /* 按钮文字颜色 */
        font-size: 14px; /* 字体大小 */
        cursor: pointer;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

</style>