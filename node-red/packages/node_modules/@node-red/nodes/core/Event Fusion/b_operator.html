<script type="text/html" data-template-name="Operator">
    <div id="node-input-input-container">
        <!-- 动态生成 sensor 或 operator 的输入行 -->
    </div>

    <div class="form-row">
        <label for="node-input-operator"><i class="fa fa-calculator"></i> Operator</label>
        <select id="node-input-operator">
            <option value="" disabled selected>Select an Operator</option>
        </select>
    </div>

    <!-- 动态显示输入框 -->
    <div class="form-row" id="node-input-dynamic-value-container" style="display: none;">
        <label for="node-input-dynamic-value"><i class="fa fa-pencil"></i> Value</label>
        <input type="number" id="node-input-dynamic-value" placeholder="Enter value">
    </div>

    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-sign-out"></i> Output</label>
        <select id="node-input-output">
            <option value="" disabled selected>Select output item for the next node</option>
        </select>
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('Operator', {
        category: 'Event Fusion',
        color: "#fff082",
        defaults: {
            value: { value: null }, // 动态输入框的值
            operator: { value: "" }, // 运算符
            output: { value: "" } // 输出字段
        },
        inputs: 1,
        outputs: 1,
        icon: "cog.svg",
        label: function () {
            if (this.operator && this.value) {
                return `Operator: ${this.operator} (${this.value})`;
            } else if (this.operator) {
                return `Operator: ${this.operator}`;
            } else {
                return "Operator: ";
            }
        },
        oneditprepare: function () {
            var node = this;

            // 获取所有数据（从 `/api/fusion/operator/`）
            $.getJSON("http://127.0.0.1:8080/api/fusion/operator/", function (data) {
                var operatorSelect = $("#node-input-operator");
                var outputSelect = $("#node-input-output");

                // 清空并填充 Operator 下拉框
                operatorSelect.empty().append('<option value="" disabled selected>Select an Operator</option>');
                outputSelect.empty().append('<option value="" disabled selected>Select output item for the next node</option>');

                data.forEach(function (op) {
                    operatorSelect.append($("<option></option>")
                        .attr("value", op.operatorName)
                        .text(op.operatorName)
                        .data("requiredInput", op.requiredInput) // 从 API 数据中保存 requiredInput 信息
                        .data("outputName", op.outputName) // 保存 outputName 信息
                    );
                });

                // 初始化 Operator 下拉框
                if (node.operator) {
                    operatorSelect.val(node.operator);
                    updateDynamicInput(); // 根据 operator 初始化输入框
                    updateOutput(node.output); // 根据 operator 初始化输出
                }

                // 当 Operator 改变时动态更新输入框和 Output 下拉框
                operatorSelect.change(function () {
                    var selectedOperator = $(this).val();
                    updateDynamicInput(); // 更新输入框
                    updateOutput(); // 更新输出下拉框
                });

                // 动态显示/隐藏输入框（基于 requiredInput）
                function updateDynamicInput() {
                    var requiredInput = operatorSelect.find(":selected").data("requiredInput");
                    if (requiredInput) {
                        $("#node-input-dynamic-value-container").show();
                        $("#node-input-dynamic-value").val(node.value || ""); // 恢复之前输入的值（若有）
                    } else {
                        $("#node-input-dynamic-value-container").hide();
                        $("#node-input-dynamic-value").val(""); // 清空值
                    }
                }

                // 初始化或更新 Output 下拉框
                function updateOutput(preselectedOutput) {
                    var selectedOutputName = operatorSelect.find(":selected").data("outputName");

                    // 清空并重新填充下拉框
                    outputSelect.empty().append('<option value="" disabled selected>Select output item for the next node</option>');

                    if (selectedOutputName) {
                        outputSelect.append($("<option></option>").attr("value", selectedOutputName).text(selectedOutputName));
                        if (preselectedOutput === selectedOutputName) {
                            outputSelect.val(preselectedOutput); // 恢复之前选择的值
                        }
                    }
                }
            });
        },
        oneditsave: function () {
            var node = this;

            // 保存 Operator
            node.operator = $("#node-input-operator").val();

            // 保存 Value
            if ($("#node-input-dynamic-value-container").is(":visible")) {
                node.value = $("#node-input-dynamic-value").val();
            } else {
                node.value = null;
            }

            // 保存 Output
            node.output = $("#node-input-output").val();
        }
    });
</script>