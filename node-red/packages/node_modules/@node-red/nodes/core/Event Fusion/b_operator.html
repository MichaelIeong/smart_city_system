<script type="text/html" data-template-name="Operator">
    <div id="node-input-input-container">
        <!-- 动态生成 sensor 或 operator 的输入行 -->
    </div>

    <div class="form-row">
        <label for="node-input-operator"><i class="fa fa-calculator"></i> Operator</label>
        <select id="node-input-operator">
            <option value="" disabled selected>Select an Operator</option>
        </select>
    </div>

    <!-- 动态显示输入框 -->
    <div class="form-row" id="node-input-dynamic-value-container" style="display: none;">
        <label for="node-input-dynamic-value"><i class="fa fa-pencil"></i> Value</label>
        <input type="number" id="node-input-dynamic-value" placeholder="Enter value">
    </div>

    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-sign-out"></i> Output</label>
        <select id="node-input-output">
            <option value="" disabled selected>Select output item for the next node</option>
        </select>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('Operator', {
        category: 'Event Fusion',
        color: "#fff082",
        defaults: {
            input: { value: "" },
            operator: { value: "" },
            dynamicValue: { value: null },
            output: { value: "" }
        },
        inputs: 1,
        outputs: 1,
        icon: "cog.svg",
        label: function () {
            if (this.operator && this.dynamicValue) {
                return `Operator: ${this.operator} (${this.dynamicValue})`;
            } else if (this.operator) {
                return `Operator: ${this.operator}`;
            } else {
                return "Operator: ";
            }
        },
        oneditprepare: function () {
            var node = this;

            // 定义需要数值输入的操作符名称（英文）
            var numericOperators = ["Greater than", "Less than", "Equals"];

            // 获取所有数据（从 `/api/fusion/operator/`）
            $.getJSON("http://127.0.0.1:8080/api/fusion/operator/", function (data) {
                var operatorSelect = $("#node-input-operator");
                var outputSelect = $("#node-input-output");

                // 清空并填充 Operator 下拉框
                operatorSelect.empty().append('<option value="" disabled selected>Select an Operator</option>');
                outputSelect.empty().append('<option value="" disabled selected>Select output item for the next node</option>');

                data.forEach(function (op) {
                    operatorSelect.append($("<option></option>")
                        .attr("value", op.operatorName)
                        .text(op.operatorName)
                        .data("outputName", op.outputName)
                    );
                });

                // 初始化操作符选择
                if (node.operator) {
                    operatorSelect.val(node.operator);
                    updateDynamicInput(node.operator); // 判断是否显示输入框
                    updateOutput(node.output);         // 初始化输出下拉框
                }

                // 当 Operator 改变时动态更新输入框和 Output 下拉框
                $("#node-input-operator").change(function () {
                    var selectedOperator = $(this).val();
                    updateDynamicInput(selectedOperator); // 更新输入框

                    // 获取所选Operator对应的outputName
                    var selectedOutputName = $("#node-input-operator").find(":selected").data("outputName");

                    // 更新 Output 下拉框
                    outputSelect.empty().append('<option value="" disabled selected>Select output item for the next node</option>');
                    updateOutput(selectedOutputName);
                });

                // 动态显示/隐藏输入框
                function updateDynamicInput(operatorName) {
                    if (numericOperators.includes(operatorName)) {
                        $("#node-input-dynamic-value-container").show();
                        $("#node-input-dynamic-value").val(node.dynamicValue || ""); // 恢复之前输入的值（若有）
                    } else {
                        $("#node-input-dynamic-value-container").hide();
                        $("#node-input-dynamic-value").val(""); // 清空值
                    }
                }

                // 初始化 Output 下拉框
                function updateOutput(outputName) {
                    if (outputName) {
                        outputSelect.append($("<option></option>").attr("value", outputName).text(outputName));
                        if (node.output === outputName) {
                            outputSelect.val(node.output); // 恢复之前选择的值
                        }
                    }
                }
            });
        },
        oneditsave: function () {
            var node = this;
            node.operator = $("#node-input-operator").val();

            // 如果输入框显示，则保存数值；否则清空
            if ($("#node-input-dynamic-value-container").is(":visible")) {
                node.dynamicValue = $("#node-input-dynamic-value").val();
            } else {
                node.dynamicValue = null;
            }

            node.output = $("#node-input-output").val();
        }
    });
</script>