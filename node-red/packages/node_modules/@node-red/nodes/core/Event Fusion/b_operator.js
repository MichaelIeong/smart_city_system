module.exports = function (RED) {
    "use strict";

    function OperatorNode(n) {
        RED.nodes.createNode(this, n);
        var node = this;

        // 初始化节点属性
        this.value = n.value; // 动态输入框的值
        this.operator = n.operator; // 运算符
        this.output = n.output; // 输出字段

        var newMsg = {};
        newMsg.steps = parseInt(0);
        var isadd = false;
        var linkcount = this.wires.length;
        var count = 0;

        this.on("input", function (msg, send, done) {
            count++;
            newMsg.steps = parseInt(Math.max(newMsg.steps, msg.steps + 1));

            if (!isadd) {
                var new_msg = {};

                // 填充新消息
                new_msg.type = node.type;
                new_msg.step = parseInt(newMsg.steps);

                // 使用 value 作为输入值
                new_msg.value = node.value;

                new_msg.operator = node.operator;
                new_msg.output = node.output;

                var nodeName = node.id; // 节点的唯一 ID
                newMsg[nodeName] = new_msg;
                isadd = true;
            }

            // 移除旧的 `steps` 字段
            delete msg.steps;

            // 合并新的消息
            Object.assign(newMsg, msg);

            // 当所有链接的节点都被处理完后，发送消息
            if (count === linkcount) {
                send(newMsg);
                done();
            }
        });
    }

    // 注册节点类型
    RED.nodes.registerType("Operator", OperatorNode);
};