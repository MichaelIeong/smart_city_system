module.exports = function (RED) {
    "use strict";

    function PublishNode(config) {
        RED.nodes.createNode(this, config);
        let node = this;
        node.rulename = config.rulename;
        node.fusionTarget = config.fusionTarget;
        this.on("input", function (msg, send, done) {
            msg.rulename = node.rulename;
            msg.fusionTarget = node.fusionTarget;
            delete msg._msgid; // 删除 _msgid 字段
            let flowNodes = [];
            RED.nodes.eachNode(function(n) {
                flowNodes.push(n);
            });
            // 将节点数据转换为 JSON 字符串
            let flowJson = JSON.stringify(flowNodes, null, 2);
            const dataToSend = {
                ruleJson: msg,
                flowJson: flowJson,
                fusionTarget: fusionTarget
            };
            const postData = JSON.stringify(dataToSend);
            console.log(JSON.stringify(msg, null, 2));
            fetch('http://127.0.0.1:8080/api/node-red/uploadrule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: postData
            })
        });
    }

    RED.nodes.registerType("Publish", PublishNode);
}
