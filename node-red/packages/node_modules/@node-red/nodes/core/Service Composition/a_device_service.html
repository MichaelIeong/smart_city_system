<script type="text/html" data-template-name="Device Service">
    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <select id="node-input-location">
            <option value="" disabled selected>Select Location</option>
        </select>
    </div>

    <div class="form-row">
        <button type="button" id="node-input-switch-to-type" class="btn btn-secondary">Switch to Device Type</button>
    </div>

    <div class="form-row" id="device-name-row">
        <label for="node-input-device-name"><i class="fa fa-mobile"></i> Device Name</label>
        <select id="node-input-device-name">
            <option value="" disabled selected>Select Device Name</option>
        </select>
    </div>

    <div class="form-row" id="deviceType-row" style="display: none;">
        <label for="node-input-deviceType"><i class="fa fa-window-restore"></i> Device Type</label>
        <select id="node-input-deviceType">
            <option value="" disabled selected>Select Device Type</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-deviceService"><i class="fa fa-cogs"></i> Actuating Function</label>
        <select id="node-input-deviceService">
            <option value="" disabled selected>Select Actuating Function</option>
        </select>
    </div>

    <!-- 隐藏字段用于保存 deviceId -->
    <input type="hidden" id="node-input-device-id"/>
</script>

<script type="text/javascript">
    RED.nodes.registerType('Device Service', {
        category: 'Service Composition',
        color: "#efa1f8",
        defaults: {
            name: { value: "" },
            location: { value: "" },
            deviceName: { value: "" },
            deviceType: { value: "" },
            deviceService: { value: "" },
            deviceId: { value: "" }  // 添加 deviceId 作为默认值
        },
        inputs: 1,
        outputs: 1,
        icon: "light.svg",
        label: function () {
            if (this.deviceName) {
                return "Device Service : " + this.deviceName;
            } else {
                return "Device Service : ";
            }
        },
        oneditprepare: function () {
            var node = this;
            var projectId = 1;
            var devicesData = [];

            var locationSelect = $("#node-input-location");
            var deviceNameSelect = $("#node-input-device-name");
            var deviceTypeSelect = $("#node-input-deviceType");
            var deviceServiceSelect = $("#node-input-deviceService");
            var deviceIdInput = $("#node-input-device-id");

            function populateSelectOptions(selectElement, options, defaultText) {
                selectElement.empty().append('<option value="" disabled selected>' + defaultText + '</option>');
                options.forEach(function (option) {
                    selectElement.append($("<option></option>").attr("value", option.value).text(option.text));
                });
            }

            function updateDeviceServices(selectedDevice, type) {
                deviceServiceSelect.empty().append('<option value="" disabled selected>Select Actuating Function</option>');
                var filteredDevice = devicesData.find(function (device) {
                    return (type === 'deviceName' && device.deviceName === selectedDevice) ||
                        (type === 'deviceType' && device.deviceType === selectedDevice);
                });
                if (filteredDevice && Array.isArray(filteredDevice.function)) {
                    filteredDevice.function.forEach(function (func) {
                        deviceServiceSelect.append($("<option></option>").attr("value", func).text(func));
                    });
                }
                if (node.deviceService) {
                    deviceServiceSelect.val(node.deviceService);
                }
            }

            $.getJSON("http://127.0.0.1:8080/api/fusion/sensor/" + projectId, function (data) {
                if (!data || data.length === 0) {
                    console.error("No data received from the API.");
                    return;
                }
                devicesData = data;

                // 填充 Location
                var locations = Array.from(new Set(data.map(device => device.location)));
                populateSelectOptions(locationSelect, locations.map(loc => ({
                    value: loc,
                    text: loc
                })), "Select Location");

                locationSelect.val(node.location);

                locationSelect.off('change').on('change', function () {
                    var selectedLocation = locationSelect.val();
                    var filteredDevices = devicesData.filter(device => device.location === selectedLocation);

                    var deviceNames = filteredDevices.map(device => ({
                        value: device.deviceName,
                        text: device.deviceName
                    }));
                    var deviceTypes = filteredDevices.map(device => ({
                        value: device.deviceType,
                        text: device.deviceType
                    }));

                    populateSelectOptions(deviceNameSelect, deviceNames, "Select Device Name");
                    populateSelectOptions(deviceTypeSelect, deviceTypes, "Select Device Type");

                    deviceServiceSelect.empty().append('<option value="" disabled selected>Select Actuating Function</option>');

                    if (node.deviceName) {
                        deviceNameSelect.val(node.deviceName);
                        updateDeviceServices(node.deviceName, 'deviceName');
                    }

                    if (node.deviceType) {
                        deviceTypeSelect.val(node.deviceType);
                        updateDeviceServices(node.deviceType, 'deviceType');
                    }
                });

                deviceNameSelect.off('change').on('change', function () {
                    var selectedDeviceName = deviceNameSelect.val();
                    updateDeviceServices(selectedDeviceName, 'deviceName');

                    var selectedDevice = devicesData.find(device => device.deviceName === selectedDeviceName);
                    if (selectedDevice) {
                        deviceIdInput.val(selectedDevice.sensorId);  // 这里用 sensorId 作为 deviceId
                    }
                });

                deviceTypeSelect.off('change').on('change', function () {
                    var selectedDeviceType = deviceTypeSelect.val();
                    updateDeviceServices(selectedDeviceType, 'deviceType');

                    var selectedDevice = devicesData.find(device => device.deviceType === selectedDeviceType);
                    if (selectedDevice) {
                        deviceIdInput.val(selectedDevice.sensorId);  // 这里用 sensorId 作为 deviceId
                    }
                });

                if (node.location) {
                    locationSelect.trigger('change');
                }
            });

            function initView() {
                if (node.deviceName && node.deviceName !== "") {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                } else if (node.deviceType && node.deviceType !== "") {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            }

            initView();

            $("#node-input-switch-to-type").off('click').on('click', function () {
                var isDeviceNameVisible = $("#device-name-row").is(":visible");
                if (isDeviceNameVisible) {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            });
        },
        oneditsave: function () {
            this.name = $("#node-input-name").val();
            this.location = $("#node-input-location").val();
            this.deviceName = $("#node-input-device-name").val();
            this.deviceType = $("#node-input-deviceType").val();
            this.deviceService = $("#node-input-deviceService").val();
            this.deviceId = $("#node-input-device-id").val();

            console.log("Saved node state:", {
                name: this.name,
                location: this.location,
                deviceName: this.deviceName,
                deviceType: this.deviceType,
                deviceService: this.deviceService,
                deviceId: this.deviceId
            });
        }
    });
</script>