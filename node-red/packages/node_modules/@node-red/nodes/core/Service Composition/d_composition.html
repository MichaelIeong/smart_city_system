<script type="text/html" data-template-name="Composition">
    <div id="node-input-service-container">
        <!-- 动态生成 service 节点的输入行，仅展示不可修改 -->
    </div>

    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <span id="node-input-location" class="input-text">No location available</span>
    </div>

    <div class="form-row">
        <label for="node-input-composition-name"><i class="fa fa-object-composition"></i> Composition Name</label>
        <input type="text" id="node-input-composition-name" placeholder="Enter Composition Name" />
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('Composition', {
        category: 'Service Composition',
        color: "#a0d468",
        defaults: {
            services: {value: ""},
            location: {value: ""},
            compositionName: {value: ""}
        },
        inputs: 1,
        outputs: 0,
        icon: "cog.svg",
        label: function () {
            if (this.compositionName) {
                return "Composition : " + this.compositionName;
            } else {
                return "Composition";
            }
        },
        oneditprepare: function () {
            var node = this;
            var linkedNodes = [];

            // 找到连接到该 Composition 节点的所有上游节点（service 节点）
            RED.nodes.eachLink(function (link) {
                if (link.target.id === node.id) {
                    linkedNodes.push(link.source);
                }
            });

            // 清空 service 容器
            $("#node-input-service-container").empty();

            // 动态创建 service 行，显示与之相连的 service 节点的服务内容
            linkedNodes.forEach(function (linkedNode, index) {
                if (linkedNode.type === 'service') {
                    // 只读取 service 节点的服务名称和 location
                    var serviceLabel = `Service ${index + 1}`;
                    var serviceValue = linkedNode.service || "No service available";

                    var serviceRow = `
                        <div class="form-row">
                            <label for="node-input-service-${index}"><i class="fa fa-cogs"></i> ${serviceLabel}</label>
                            <span id="node-input-service-${index}" class="input-text">${serviceValue}</span>
                        </div>
                    `;
                    $("#node-input-service-container").append(serviceRow);

                    // 仅展示第一个 service 节点的 location
                    if (index === 0 && linkedNode.location) {
                        $("#node-input-location").text(linkedNode.location);
                    }
                }
            });
        },
        oneditsave: function () {
            var node = this;
            node.compositionName = $("#node-input-composition-name").val();
            node.services = [];

            // 获取动态生成的 service 行的内容
            $("#node-input-service-container .input-text").each(function (index, element) {
                node.services.push($(element).text());
            });

            // 保存展示的 location
            node.location = $("#node-input-location").text();
        }
    });
</script>