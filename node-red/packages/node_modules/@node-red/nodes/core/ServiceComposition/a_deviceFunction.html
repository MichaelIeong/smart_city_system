<script type="text/html" data-template-name="deviceService">

    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <select id="node-input-location">
            <option value="" disabled selected>Select Location</option>
            <!-- 后端获取的location将动态添加 -->
        </select>
    </div>

    <div class="form-row">
        <button type="button" id="node-input-switch-to-type" class="btn btn-secondary">Switch to Device Type</button>
    </div>

    <div class="form-row" id="device-name-row">
        <label for="node-input-device-name"><i class="fa fa-mobile"></i> Device Name</label>
        <select id="node-input-device-name">
            <option value="" disabled selected>Select Device Name</option>
            <!-- 后端获取的device将动态添加 -->
        </select>
    </div>

    <div class="form-row" id="deviceType-row" style="display: none;">
        <label for="node-input-deviceType"><i class="fa fa-window-restore"></i> Device Type</label>
        <select id="node-input-deviceType">
            <option value="" disabled selected>Select Device Type</option>
            <!-- 后端获取的deviceType将动态添加 -->
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-deviceService"><i class="fa fa-cogs"></i> Actuating Function</label>
        <select id="node-input-deviceService">
            <option value="" disabled selected>Select Actuating Function</option>
            <!-- 后端获取的deviceService将动态添加 -->
            <option value="安排巡逻人员">安排巡逻人员</option>
            <option value="通知交管中心">通知交管中心</option>
            <option value="信号控制">信号控制</option>
            <option value="紧急优先">紧急优先</option>
            <option value="呼叫工作人员处理异常">呼叫工作人员处理异常</option>
            <option value="停车场道闸抬杆">停车场道闸抬杆</option>
            <option value="检查车位数信息">检查车位数信息</option>
        </select>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('deviceService', {
        category: 'ServiceComposition',
        color: "#a1d3f8",
        defaults: {
            name: { value: "" },
            location: { value: "" },
            deviceName: { value: "" },
            deviceType: { value: "" },
            deviceService: { value: "" }
        },
        inputs: 0,
        outputs: 1,
        icon: "bridge.svg",
        label: function () {
            if (this.deviceService) {
                return "deviceService : " + this.deviceService;
            }else {
                return "deviceService : ";
            }
        },
        oneditprepare: function () {
            var node = this;

            // 预填充Location下拉框
            $.getJSON("/project/spacelist", function (data) {
                var locationSelect = $("#node-input-location");
                data.forEach(function (space) {
                    locationSelect.append($("<option></option>").attr("value", space.id).text(space.name));
                });
                locationSelect.val(node.location);
            });

            // 初始化Device Name下拉框
            $.getJSON("/deviceService/devicelist?type=device", function (data) {
                var deviceNameSelect = $("#node-input-device-name");
                data.devices.forEach(function (device) {
                    deviceNameSelect.append($("<option></option>").attr("value", device.id).text(device.name));
                });
                deviceNameSelect.val(node.deviceName);
            });

            // 初始化Device Type下拉框
            $.getJSON("/deviceService/devicelist?type=deviceType", function (data) {
                var deviceTypeSelect = $("#node-input-deviceType");
                data.deviceTypes.forEach(function (type) {
                    deviceTypeSelect.append($("<option></option>").attr("value", type.id).text(type.name));
                });
                deviceTypeSelect.val(node.deviceType);
            });

            // 初始化Ability下拉框
            $.getJSON("/deviceService/deviceServicelist", function (data) {
                var deviceServiceSelect = $("#node-input-deviceService");
                data.deviceServices.forEach(function (deviceService) {
                    deviceServiceSelect.append($("<option></option>").attr("value", deviceService.id).text(deviceService.name));
                });
                deviceServiceSelect.val(node.deviceService);
            });

            // 初始视图设定
            function initView() {
                if (node.deviceName && node.deviceName !== "") {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                } else if (node.deviceType && node.deviceType !== "") {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                }
            }

            initView(); // 在准备编辑时设置初始视图

            // 按钮点击事件，切换显示设备类型
            $("#node-input-switch-to-type").click(function () {
                var isDeviceNameVisible = $("#device-name-row").is(":visible");
                if (isDeviceNameVisible) {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            });
        },
        oneditsave: function () {
            this.name = $("#node-input-name").val();
            this.location = $("#node-input-location").val();
            this.deviceName = $("#node-input-device-name").val();
            this.deviceType = $("#node-input-deviceType").val();
            this.deviceService = $("#node-input-deviceService").val();
        }
    });
</script>