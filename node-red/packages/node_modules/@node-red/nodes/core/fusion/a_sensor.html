<script type="text/html" data-template-name="sensor">

    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <select id="node-input-location">
            <option value="" disabled selected>Select Location</option>
            <option value="all room">All Room</option>
            <option value="南京路">南京路</option>
            <option value="路口">路口</option>
            <option value="园区大门">园区大门</option>
            <option value="车库入口">车库入口</option>
        </select>
    </div>

    <div class="form-row">
        <button type="button" id="node-input-switch-to-type" class="btn btn-secondary">Switch to Device Type</button>
    </div>

    <div class="form-row" id="device-name-row">
        <label for="node-input-device-name"><i class="fa fa-mobile"></i> Device Name</label>
        <select id="node-input-device-name">
            <option value="" disabled selected>Select Device Name</option>
            <option value="路口摄像头">路口摄像头</option>
            <option value="激光雷达-1">激光雷达-1</option>
        </select>
    </div>

    <div class="form-row" id="deviceType-row" style="display: none;">
        <label for="node-input-deviceType"><i class="fa fa-window-restore"></i> Device Type</label>
        <select id="node-input-deviceType">
            <option value="" disabled selected>Select Device Type</option>
            <option value="摄像头">摄像头</option>
            <option value="激光雷达">激光雷达</option>
            <option value="动作传感器">动作传感器</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-sensingFunction"><i class="fa fa-search"></i> Sensing Function</label>
        <select id="node-input-sensingFunction">
            <option value="" disabled selected>Select an ability of this sensor</option>
            <option value="video stream">video stream</option>
            <option value="radar data">radar data</option>
            <option value="action data">action data</option>
        </select>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('sensor', {
        category: 'fusion',
        color: "#f89f9f",
        defaults: {
            name: {value: ""},
            location: {value: ""},
            deviceName: {value: ""},
            deviceType: {value: ""},
            sensingFunction: {value: ""}
        },
        inputs: 0,
        outputs: 1,
        icon: "bridge.svg",
        label: function () {
            if (this.deviceName) {
                return "sensor : " + this.deviceName;
            } else if (this.deviceType) {
                return "sensor : " + this.deviceType;
            } else {
                return "sensor : ";
            }
        },
        oneditprepare: function () {
            var node = this;

            // Fetch sensor data based on projectname
            var projectId = 1; // Replace this with actual projectname variable
            $.getJSON("http://127.0.0.1:8080/api/fusion/sensor/" + projectId, function (data) {
                console.log(333);
                var locationSelect = $("#node-input-location");
                var deviceNameSelect = $("#node-input-device-name");
                var deviceTypeSelect = $("#node-input-deviceType");
                var sensingFunctionSelect = $("#node-input-sensingFunction");

                // Clear previous options
                locationSelect.empty().append('<option value="" disabled selected>Select Location</option>');
                deviceNameSelect.empty().append('<option value="" disabled selected>Select Device Name</option>');
                deviceTypeSelect.empty().append('<option value="" disabled selected>Select Device Type</option>');
                sensingFunctionSelect.empty().append('<option value="" disabled selected>Select an ability of this sensor</option>');

                // Populate the dropdowns with the data returned from the server
                data.forEach(function (sensor) {
                    // Populate location dropdown
                    locationSelect.append($("<option></option>").attr("value", sensor.location).text(sensor.location));

                    // Populate deviceName and deviceType based on whether deviceName is null or not
                    if (sensor.deviceName) {
                        deviceNameSelect.append($("<option></option>").attr("value", sensor.deviceName).text(sensor.deviceName));
                    } else {
                        deviceTypeSelect.append($("<option></option>").attr("value", sensor.deviceType).text(sensor.deviceType));
                    }

                    // Populate sensing function dropdown
                    sensingFunctionSelect.append($("<option></option>").attr("value", sensor.function).text(sensor.function));
                });

                // Set values based on the node's current settings
                locationSelect.val(node.location);
                deviceNameSelect.val(node.deviceName);
                deviceTypeSelect.val(node.deviceType);
                sensingFunctionSelect.val(node.sensingFunction);
            });

            // Initialize the view based on deviceName/deviceType
            function initView() {
                if (node.deviceName && node.deviceName !== "") {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                } else {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                }
            }

            initView(); // Set initial view

            // Handle button click to toggle between deviceName and deviceType
            $("#node-input-switch-to-type").click(function () {
                var isDeviceNameVisible = $("#device-name-row").is(":visible");
                if (isDeviceNameVisible) {
                    $("#device-name-row").hide();
                    $("#deviceType-row").show();
                    $("#node-input-switch-to-type").text("Switch to Device Name");
                } else {
                    $("#device-name-row").show();
                    $("#deviceType-row").hide();
                    $("#node-input-switch-to-type").text("Switch to Device Type");
                }
            });
        },
        oneditsave: function () {
            this.name = $("#node-input-name").val();
            this.location = $("#node-input-location").val();
            this.deviceName = $("#node-input-device-name").val();
            this.deviceType = $("#node-input-deviceType").val();
            this.sensingFunction = $("#node-input-sensingFunction").val();
        }
    });
</script>
<style>
    /* 设置所有输入框和下拉框宽度一致 */
    .form-row input[type="text"],

    .form-row select {
        width: calc(100% - 180px); /* 留出空间给标签 */
        box-sizing: border-box; /* 确保padding和border包含在宽度内 */
    }

    /* 按钮样式调整 */
    .form-row button {
        margin-left: 150px; /* 与label宽度一致 */
        padding: 10px 20px;
        background-color: rgba(255, 255, 255, 0.71); /* 按钮背景颜色 */
        border: 1px solid #b8b8b8; /* 按钮边框 */
        border-radius: 5px; /* 圆角按钮 */
        color: #000000; /* 按钮文字颜色 */
        font-size: 14px; /* 字体大小 */
        cursor: pointer;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

</style>