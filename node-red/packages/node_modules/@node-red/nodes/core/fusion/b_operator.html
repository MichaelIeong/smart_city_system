<script type="text/html" data-template-name="operator">

    <div class="form-row">
        <label for="node-input-input"><i class="fa fa-sign-in"></i> Input</label>
        <span id="node-input-input" class="input-text">Input from Sensor</span>
    </div>

    <div class="form-row">
        <label for="node-input-operator"><i class="fa fa-calculator"></i> Operator</label>
        <select id="node-input-operator">
            <option value="" disabled selected>Select an Operator</option>
            <option value="object detection">object detection</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-sign-out"></i> Output</label>
        <select id="node-input-output">
            <option value="" disabled selected>Select output item for the next node</option>
            <option value="object detection">object detection</option>
        </select>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('operator', {
        category: 'fusion',
        color: "#fff082",
        defaults: {
            input: {value: ""},
            operator: {value: ""},
            output: {value: ""}
        },
        inputs: 1,
        outputs: 1,
        icon: "cog.svg",
        label: function () {
            if (this.output) {
                return "operator : " + this.operator;
            } else {
                return "operator : ";
            }
        },
        oneditprepare: function () {
            var node = this;

            var sensorNode = null;
            RED.nodes.eachLink(function (link) {
                if (link.target.id === node.id && link.source.type === 'sensor') {
                    sensorNode = link.source;
                }
            });

            // 如果找到了 sensor 节点，显示 input 的文本内容
            if (sensorNode && sensorNode.query) {
                var sensorQuery = sensorNode.query || "";
                $("#node-input-input").text(sensorQuery); // 将传感器的 query 显示为文本
            }

            // 初始化其他字段
            // 例如：加载operator和output下拉框的选项
            $.getJSON("/project/operator", function (data) {
                var operatorSelect = $("#node-input-operator");
                data.forEach(function (operator) {
                    operatorSelect.append($("<option></option>").attr("value", operator.id).text(operator.name));
                });
            });

            $.getJSON("/event/targetevent", function (data) {
                var outputSelect = $("#node-input-output");
                data.forEach(function (output) {
                    outputSelect.append($("<option></option>").attr("value", output.id).text(output.name));
                });
            });
        },
        oneditsave: function () {
            var node = this;
            node.name = $("#node-input-name").val();
            node.input = $("#node-input-input").text(); // 获取文本内容
            node.operator = $("#node-input-operator").val();
            node.output = $("#node-input-output").val();
        }
    });
</script>